<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot TESS - TalentScope AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            -webkit-text-size-adjust: 100%;
        }
        
        /* For√ßa o input a sempre ser vis√≠vel no mobile */
        input[type="text"] {
            font-size: 16px !important; /* Previne zoom no iOS */
            min-height: 44px; /* Tamanho m√≠nimo touch-friendly */
        }
        
        /* Garante que o bot√£o seja touch-friendly */
        button {
            min-height: 44px;
            min-width: 44px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // √çcones SVG simplificados
        const SendIcon = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );

        const SparklesIcon = () => (
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 3v18M3 12h18M5.6 5.6l12.8 12.8M5.6 18.4L18.4 5.6"></path>
            </svg>
        );

        const LoaderIcon = () => (
            <svg className="animate-spin" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
            </svg>
        );

        const UserIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        );

        const UsersIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        );

        const BriefcaseIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
            </svg>
        );

        const TessAvatar = () => (
            <img 
                src="/static/agente.png" 
                alt="TESS" 
                className="w-8 h-8 md:w-10 md:h-10 rounded-full object-cover border-2 border-blue-400 shadow-lg"
                onError={(e) => {
                    e.target.style.display = 'none';
                }}
            />
        );

        const TessAvatarSmall = () => (
            <img 
                src="/static/agente.png" 
                alt="TESS" 
                className="w-7 h-7 md:w-8 md:h-8 rounded-full object-cover border-2 border-blue-400 shadow-md flex-shrink-0"
                onError={(e) => {
                    e.target.style.display = 'none';
                }}
            />
        );

        const TalentChatbot = () => {
            const [messages, setMessages] = useState([
                {
                    role: 'assistant',
                    content: 'Ol√°! Sou a TESS, assistente inteligente da TalentScope AI. Posso te ajudar a entender melhor o match entre candidatos e vagas do seu sistema. Como posso ajudar?'
                }
            ]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [contextLoading, setContextLoading] = useState(true);
            const [context, setContext] = useState({ candidates: [], jobs: [] });
            const messagesEndRef = useRef(null);

            const suggestedQuestions = [
                "Mostre todos os candidatos dispon√≠veis com seus scores",
                "Quais s√£o as vagas ativas no sistema?",
                "Recomende os melhores candidatos para cada vaga",
                "Compare todos os candidatos analisados"
            ];

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            useEffect(() => {
                loadContext();
            }, []);

            const loadContext = async () => {
                try {
                    setContextLoading(true);
                    const response = await fetch('/api/chatbot/context');
                    const data = await response.json();
                    
                    if (data.success) {
                        setContext({
                            candidates: data.candidates || [],
                            jobs: data.jobs || []
                        });
                    }
                } catch (err) {
                    console.error('Erro ao carregar contexto:', err);
                } finally {
                    setContextLoading(false);
                }
            };

            const handleSend = async () => {
                if (!input.trim() || loading) return;

                const userMessage = { role: 'user', content: input };
                setMessages(prev => [...prev, userMessage]);
                setInput('');
                setLoading(true);

                try {
                    const response = await fetch('/api/chatbot/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: input })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        setMessages(prev => [...prev, { 
                            role: 'assistant', 
                            content: data.response 
                        }]);
                    }
                } catch (err) {
                    setMessages(prev => [...prev, { 
                        role: 'assistant', 
                        content: '‚ùå Erro ao processar pergunta. Tente novamente.' 
                    }]);
                } finally {
                    setLoading(false);
                }
            };

            const formatMessage = (content) => {
                return content.split('\n').map((line, i) => {
                    const trimmed = line.trim();
                    
                    if (trimmed.startsWith('## ')) {
                        return <h2 key={i} className="text-lg font-bold mt-4 mb-2">{trimmed.replace('## ', '')}</h2>;
                    } else if (trimmed.startsWith('### ')) {
                        return <h3 key={i} className="text-base font-semibold mt-3 mb-2">{trimmed.replace('### ', '')}</h3>;
                    } else if (trimmed.startsWith('- ') || trimmed.startsWith('‚Ä¢ ')) {
                        return <p key={i} className="ml-4 my-1">{trimmed}</p>;
                    } else if (trimmed) {
                        return <p key={i} className="my-1">{trimmed}</p>;
                    }
                    return null;
                });
            };

            if (contextLoading) {
                return (
                    <div className="flex items-center justify-center h-screen bg-gradient-to-br from-slate-50 to-blue-50">
                        <div className="text-center">
                            <LoaderIcon />
                            <p className="text-slate-600 font-medium mt-4">Carregando dados...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-screen bg-gradient-to-br from-slate-50 to-blue-50">
                    {/* Header */}
                    <div className="bg-white border-b border-slate-200 shadow-sm">
                        <div className="max-w-5xl mx-auto px-4 md:px-6 py-3 md:py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2 md:gap-3">
                                    <TessAvatar />
                                    <div>
                                        <h1 className="text-base md:text-xl font-bold text-slate-800">TESS</h1>
                                        <p className="text-xs md:text-sm text-slate-500 hidden sm:block">Assistente Inteligente</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2 md:gap-4 text-xs md:text-sm">
                                    <div className="flex items-center gap-1 md:gap-2">
                                        <UsersIcon />
                                        <span className="font-medium hidden sm:inline">{context.candidates.length} candidatos</span>
                                        <span className="font-medium sm:hidden">{context.candidates.length}</span>
                                    </div>
                                    <div className="flex items-center gap-1 md:gap-2">
                                        <BriefcaseIcon />
                                        <span className="font-medium hidden sm:inline">{context.jobs.length} vagas</span>
                                        <span className="font-medium sm:hidden">{context.jobs.length}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Chat Area */}
                    <div className="flex-1 overflow-y-auto px-3 md:px-6 py-4 md:py-6">
                        <div className="max-w-4xl mx-auto space-y-4 md:space-y-6">
                            {messages.map((msg, idx) => (
                                <div key={idx} className={`flex gap-2 md:gap-3 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    {msg.role === 'assistant' && <TessAvatarSmall />}
                                    
                                    <div className={`max-w-[85%] md:max-w-2xl rounded-2xl px-3 py-3 md:px-5 md:py-4 text-sm md:text-base ${
                                        msg.role === 'user' 
                                            ? 'bg-blue-600 text-white' 
                                            : 'bg-white shadow-md border border-slate-200'
                                    }`}>
                                        {msg.role === 'user' ? (
                                            <p>{msg.content}</p>
                                        ) : (
                                            <div className="text-slate-700">{formatMessage(msg.content)}</div>
                                        )}
                                    </div>

                                    {msg.role === 'user' && (
                                        <div className="w-7 h-7 md:w-8 md:h-8 rounded-full bg-slate-700 flex items-center justify-center flex-shrink-0">
                                            <UserIcon />
                                        </div>
                                    )}
                                </div>
                            ))}

                            {loading && (
                                <div className="flex gap-2 md:gap-3">
                                    <TessAvatarSmall />
                                    <div className="bg-white rounded-2xl px-3 py-3 md:px-5 md:py-4 shadow-md text-sm md:text-base">
                                        <div className="flex items-center gap-2">
                                            <LoaderIcon />
                                            <span>Analisando...</span>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div ref={messagesEndRef} />
                        </div>
                    </div>

                    {/* Suggestions */}
                    {messages.length === 1 && context.candidates.length > 0 && (
                        <div className="px-3 md:px-6 pb-3 md:pb-4 bg-gradient-to-br from-slate-50 to-blue-50">
                            <div className="max-w-4xl mx-auto">
                                <p className="text-sm text-slate-600 mb-3 font-medium">üí° Sugest√µes:</p>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                    {suggestedQuestions.map((q, idx) => (
                                        <button
                                            key={idx}
                                            onClick={() => setInput(q)}
                                            className="text-left px-4 py-3 bg-white hover:bg-blue-50 active:bg-blue-100 border border-slate-200 rounded-xl text-sm transition-colors shadow-sm"
                                        >
                                            {q}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Input */}
                    <div className="bg-white border-t px-3 md:px-6 py-3 md:py-4 sticky bottom-0">
                        <div className="max-w-4xl mx-auto flex gap-2 md:gap-3">
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && !e.shiftKey && handleSend()}
                                placeholder="Pergunte sobre candidatos e vagas..."
                                disabled={loading}
                                className="flex-1 px-3 py-3 md:px-5 md:py-3 text-base border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                            <button
                                onClick={handleSend}
                                disabled={loading || !input.trim()}
                                className="px-4 py-3 md:px-6 md:py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 text-base transition-all hover:shadow-lg active:scale-95"
                            >
                                {loading ? <LoaderIcon /> : <SendIcon />}
                                <span className="hidden sm:inline">{loading ? 'Enviando...' : 'Enviar'}</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<TalentChatbot />, document.getElementById('root'));
    </script>
</body>
</html>